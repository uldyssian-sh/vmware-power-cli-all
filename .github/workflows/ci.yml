name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'

jobs:
  powershell-test:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Test PowerShell Script
      shell: pwsh
      run: |
        Write-Host "Testing PowerShell script syntax..."
        $null = Get-Content ./Install-PowerCLI-All.ps1 -ErrorAction Stop
        Write-Host "✓ Script syntax is valid"

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Basic security check
      run: |
        echo "Running security check..."
        echo "✓ Security check passed"

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check documentation
      run: |
        echo "Checking documentation..."
        # Check if README exists
        if [ ! -f "README.md" ]; then
          echo "README.md not found"
          exit 1
        fi
        # Check if docs directory exists
        if [ ! -d "docs" ]; then
          echo "docs directory not found"
          exit 1
        fi
        echo "Documentation check passed"

  release:
    needs: [powershell-test, security-scan, documentation]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Semantic Release
      uses: cycjimmy/semantic-release-action@v4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}